# Игра жизнь

Проект проба rust'а и его интеграции с питоном, на примере CPU bound задачи.

Де факто, это не такая уж вычислительно сложная задача, но упираемся мы именно в CPU

![Профайлинг pure python версии](./pure%20python%20profile.png)

## Реализации

### Базовая версия

- pre render поля во избежание доп. затрат на рендер (хоть и не шибко больших)
- самые нагруженные методы - `_get` и `_neighbors` (68% CPU time там)
- render занимает порядке 17% времени
- используют numpy массив для состояния поля

### Точечно оптимизированная

**WIP промежуточные итоги и профайлинг**

- `_get` и `_neighbors` заменены на rust реализацию реализацию
- отдельно рассмотреть влияние inline'инга

### Точечно оптимизированная

**WIP промежуточные итоги и профайлинг**

- `_get` и `_neighbors` заменены на rust реализацию реализацию
- отдельно рассмотреть влияние inline'инга

### Заменена работа с полем

**WIP промежуточные итоги и профайлинг**

- используется всё то же numpy поле
- дополнительно заменена логика (вынесен `update`)
- рендер всё ещё идёт по питонячему iterate

### Заменена работа с полем

**WIP промежуточные итоги и профайлинг**

- Всё что касается работы с полем (и итерирование и само хранение), перенесено в rust
    - наружу доступен `iterate` для накидывания рендера

### Заменена логика рендера

**WIP промежуточные итоги и профайлинг**

- логика рендера у `LiveWorld` перенесена в rust

## Выводы

### Вопросы к будущим оптимизациям

- насколько сложно интегрировать rust
- как тяжело работать с питонячими объектами
    - в плюсах даже для возвращения null объектов нужны были сакральные знания иначе segfault
- как тяжело работать с внешними библиотеками (numpy и pygame - обвзяки поверх C++, нужно постораться ходить до них в
  обход питон обвязки, по возможности)
- можно ли внедрить в существующий пайплайн разработки наших проектов (у нас есть `poe configure`, как entrypoint
  проекта)
    - сложность сборки исходников под каждой из OS (достаточно ли скачать rust и запускать скриптик при развёртывании
      проекта или нужен бубен)

### Результаты

**WIP**

### Туториал по добавлению rust в python проекты

- `pip install maturin` для CLI обёртки над rust
- `maturin init` для инициализации rust файлов (в корневой проекта, `где pyproject.toml`, может его зашакалить, нужно
  быть внимательным)
- переименовать директорию в `rust_src` (src по умолчанию)
- поменять путь до файлов библиотеки в `Cargo.toml`
    - ```toml
    [lib]
    path = "rust_src/lib.rs"
    ```
- `maturing develop` для dev сборки библиотеки
    - после вызова будет собран проект (то же самое, что `poetry install --only-root`)
    - rust функции будут доступны для имопрта из проекта (`live_game.sum_as_string`)
        - одна беда, типизация не прокидывается сама
          собой ![пример вызова доступного после сборки](docs/build_rust_lib_import_example.png)
- ??? как собрать prod версию

### Проблемы

- jetbrains не соизволила завести поддержку rust'а для pycharm в виде плагина, нужна отдельная IDE (RustRover)